<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Language Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; 
            flex-direction: column; /* Arrange main sections vertically */
            align-items: center; 
            margin: 0;
            padding: 2rem;
            background-color: #f0f2f5;
        }
        h1 {
            color: #1c1e21;
            margin-bottom: 0.5rem;
        }
        p {
            margin-top: 0;
            margin-bottom: 1.5rem;
            color: #555;
        }
        #controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            width: 100%;
            max-width: 600px;
        }
        #repo-input { 
            flex-grow: 1;
            padding: 0.75rem;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            font-size: 1rem;
        }
        button { 
            margin: 2px;
            width:70px;
            padding: 0.75rem 1.5rem; 
            border: none;
            border-radius: 6px;
            background-color: #1877f2;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #166fe5;
        }
        button:disabled {
            background-color: #a0c3ed;
            cursor: not-allowed;
        }
        #top-section-container {
            display: flex;
            gap: 2rem;
            width: 100%;
            max-width: 1400px; /* Adjust as needed */
            margin-bottom: 2rem;
            align-items: flex-start;
        }
        #repo-lists-container {
            display: flex;
            flex-direction: column; /* Arrange popular and my repos vertically within this container */
            gap: 2rem;
            flex: 1; /* Take up available space */
            min-width: 400px;
        }
        #popular-repos-section, #my-repos-section {
            flex: 1;
            text-align: center;
        }
        #popular-repos-list, #my-repos-list {
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
            margin: 10px;
        }
        #popular-repos-list ul, #my-repos-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #popular-repos-list li, #my-repos-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        #popular-repos-list li:hover, #my-repos-list li:hover {
            background-color: #f0f2f5;
        }
        #popular-repos-list li:last-child, #my-repos-list li:last-child {
            border-bottom: none;
        }
        #cached-repos-list {
            width: 100%;
            max-width: 600px; /* Match controls max-width */
            margin-bottom: 2rem;
            text-align: center;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 1rem;
        }
        #cached-repos-ul {
            list-style: none;
            padding: 0;
            margin: 0;
            height: 200px;
            max-height: 200px;
            overflow-y: auto;
        }
        #cached-repos-ul li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        #cached-repos-ul li:last-child {
            border-bottom: none;
        }
        #chart-container { 
            flex: 1; /* Take up available space */
            margin: auto;
            min-width: 400px;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            height:660px;
        }
        .top {
            display: flex;
        }
        .bottom {
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>

    <h1>GitHub Repository Language Comparison</h1>
    <p>Enter comma-separated GitHub repositories (e.g., facebook/react, vuejs/vue) and click "Compare".</p>
    
    <div id="controls">
        <input type="text" id="repo-input" placeholder="owner/repo, owner2/repo2">
        <button id="add-btn">Add</button>
    </div>

    <div id="top-section-container">
        <div id="repo-lists-container">
            <div class="top">
                <div id="popular-repos-section">
                    <h2>Popular Repositories</h2>
                    <div id="popular-repos-list">
                        <!-- Popular repositories will be loaded here -->
                    </div>
                </div>

                <div id="my-repos-section">
                    <h2>My Repositories</h2>
                    <div id="my-repos-list">
                        <!-- My repositories will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="bottom">
                <div id="cached-repos-list">
                    <div id="cached-repos-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding-right: 130px;">
                        <button id="toggle-all-checkboxes" style="padding: 0.3rem 0.7rem; font-size: 0.85rem;">Toggle All</button>
                        <button id="delete-selected-btn" style="padding: 0.3rem 0.7rem; font-size: 0.85rem; background-color: #dc3545;">Delete Selected</button>
                        <h2>Currently Cached Repositories</h2>
                    </div>
                    <ul id="cached-repos-ul"></ul>
                </div>              
            </div>
        </div>

        <div id="chart-container">
            <canvas id="language-chart"></canvas>
            <div id="chart-message" style="text-align: center; padding: 1rem; padding-top: 130px;"></div>
        </div>
    </div>
    <script>
        const repoInput = document.getElementById('repo-input');
        const addBtn = document.getElementById('add-btn');
        const popularReposList = document.getElementById('popular-repos-list');
        const myReposList = document.getElementById('my-repos-list'); // Added this line
        const cachedReposUl = document.getElementById('cached-repos-ul');
        const toggleAllCheckboxesBtn = document.getElementById('toggle-all-checkboxes'); // Added this line
        const deleteSelectedBtn = document.getElementById('delete-selected-btn'); // Added this line
        const chartInstances = new Map();
        const CACHE_KEY = 'cachedRepos';

        document.addEventListener('DOMContentLoaded', () => {
            fetchPopularRepos();
            fetchMyRepos(); // Added this line
            loadCachedReposFromStorage();
            generateGraphFromCheckedRepos();
        });

        addBtn.addEventListener('click', handleAdd);
        repoInput.addEventListener('keypress', e => e.key === 'Enter' && handleAdd());
        toggleAllCheckboxesBtn.addEventListener('click', toggleAllCheckboxes); // Added this line
        deleteSelectedBtn.addEventListener('click', handleDeleteSelected); // Added this line

        function handleDeleteSelected() {
            const checkboxes = document.querySelectorAll('#cached-repos-ul input[type="checkbox"]:checked');
            const reposToDelete = Array.from(checkboxes).map(cb => cb.value);

            if (reposToDelete.length === 0) {
                alert('No repositories selected to delete.');
                return;
            }

            if (confirm(`Are you sure you want to remove ${reposToDelete.length} selected repositories?`)) {
                let currentRepos = getCachedRepos();
                const updatedRepos = currentRepos.filter(repo => !reposToDelete.includes(repo));
                saveCachedRepos(updatedRepos);

                // Remove from UI
                reposToDelete.forEach(repo => {
                    const li = document.getElementById(`cached-repo-${repo.replace(/\//g, '-')}`).closest('li');
                    if (li) li.remove();
                });
                generateGraphFromCheckedRepos();
            }
        }

        function handleAdd() {
            const customRepos = repoInput.value.trim().split(',').map(repo => repo.trim()).filter(Boolean);
            if (customRepos.length === 0) return;

            const currentRepos = getCachedRepos();
            const newRepos = customRepos.filter(repo => !currentRepos.includes(repo));

            newRepos.forEach(repo => addRepoToCachedList_UI_Only(repo));
            saveCachedRepos([...currentRepos, ...newRepos]);
            
            generateGraphFromCheckedRepos();
            repoInput.value = '';
        }

        function loadCachedReposFromStorage() {
            const repos = getCachedRepos();
            repos.forEach(repo => addRepoToCachedList_UI_Only(repo));
        }

        function getCachedRepos() {
            return JSON.parse(localStorage.getItem(CACHE_KEY) || '[]');
        }

        function saveCachedRepos(repos) {
            localStorage.setItem(CACHE_KEY, JSON.stringify(repos));
        }

        function addRepoToCachedList_UI_Only(repo) {
            if (document.getElementById(`cached-repo-${repo.replace(/\//g, '-')}`)) return;

            const li = document.createElement('li');
            Object.assign(li.style, { display: 'flex', alignItems: 'center', gap: '0.5rem' });

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `cached-repo-${repo.replace(/\//g, '-')}`;
            checkbox.value = repo;
            checkbox.checked = true;

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = repo;
            label.style.flexGrow = '1';

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            Object.assign(deleteBtn.style, { marginLeft: 'auto', padding: '0.2rem 0.5rem', fontSize: '0.8rem', backgroundColor: '#dc3545' });

            checkbox.addEventListener('change', generateGraphFromCheckedRepos);

            deleteBtn.addEventListener('click', () => {
                if (confirm(`Are you sure you want to remove ${repo}?`)) {
                    const currentRepos = getCachedRepos();
                    saveCachedRepos(currentRepos.filter(r => r !== repo));
                    li.remove();
                    generateGraphFromCheckedRepos();
                }
            });

            li.appendChild(checkbox);
            li.appendChild(label);
            li.appendChild(deleteBtn);
            cachedReposUl.appendChild(li);
        }

        function toggleAllCheckboxes() { // Added this function
            const checkboxes = document.querySelectorAll('#cached-repos-ul input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            generateGraphFromCheckedRepos();
        }

        async function generateGraphFromCheckedRepos() {
            const messageEl = document.getElementById('chart-message');
            const checkedRepos = Array.from(document.querySelectorAll('#cached-repos-ul input[type="checkbox"]:checked')).map(cb => cb.value);

            if (chartInstances.has('language-chart')) {
                chartInstances.get('language-chart').destroy();
                chartInstances.delete('language-chart');
            }
            messageEl.textContent = '';

            if (checkedRepos.length === 0) {
                messageEl.textContent = 'Add or select repositories to see the language distribution.';
                return;
            }

            messageEl.textContent = 'Loading chart data...';

            try {
                const repoQuery = encodeURIComponent(checkedRepos.join(','));
                const response = await fetch(`http://localhost:3000/api/compare?repos=${repoQuery}`);
                if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch graph data.');
                
                const data = await response.json();
                messageEl.textContent = '';

                if (data && Object.keys(data).length > 0) {
                    renderChart('language-chart', 'Language Usage Distribution', data);
                } else {
                    messageEl.textContent = 'No language data found for the selected repositories.';
                }
            } catch (error) {
                messageEl.textContent = `Error: ${error.message}`;
                console.error('Graph generation failed:', error);
            }
        }

        async function fetchPopularRepos() {
            popularReposList.innerHTML = 'Loading popular repositories...';
            try {
                const response = await fetch('http://localhost:3000/api/popular-repos');
                if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch popular reps.');
                const repos = await response.json();
                displayReposInList(popularReposList, repos);
            } catch (error) {
                console.error('Failed to fetch popular repos:', error);
                popularReposList.innerHTML = 'Failed to load popular repositories.';
            }
        }

        async function fetchMyRepos() {
            myReposList.innerHTML = 'Loading your repositories...';
            try {
                const response = await fetch('http://localhost:3000/api/my-repos');
                if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch your repos.');
                const repos = await response.json();
                displayReposInList(myReposList, repos);
            } catch (error) {
                console.error('Failed to fetch your repos:', error);
                myReposList.innerHTML = 'Failed to load your repositories.';
            }
        }

        function displayReposInList(listElement, repos) {
            listElement.innerHTML = '';
            const ul = document.createElement('ul');
            Object.assign(ul.style, { listStyle: 'none', padding: '0', maxHeight: '200px', overflowY: 'auto', border: '1px solid #eee', borderRadius: '4px', marginTop: '1rem' });

            repos.forEach(repo => {
                const li = document.createElement('li');
                li.style.padding = '0.5rem';
                li.style.borderBottom = '1px solid #eee';
                li.textContent = repo;
                li.addEventListener('click', () => {
                    const currentRepos = getCachedRepos();
                    if (!currentRepos.includes(repo)) {
                        addRepoToCachedList_UI_Only(repo);
                        saveCachedRepos([...currentRepos, repo]);
                        generateGraphFromCheckedRepos();
                    }
                });
                ul.appendChild(li);
            });
            listElement.appendChild(ul);
        }

        function renderChart(canvasId, chartTitle, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return console.error(`Canvas with id ${canvasId} not found.`);

            if (chartInstances.has(canvasId)) {
                chartInstances.get(canvasId).destroy();
            }

            const chart = new Chart(canvas.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Language Usage',
                        data: Object.values(data).map(d => d.percentage),
                        backgroundColor: generatePastelColors(Object.keys(data).length),
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right' },
                        title: { display: true, text: chartTitle, font: { size: 18 } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed.toFixed(1)}%` } }
                    }
                }
            });
            chartInstances.set(canvasId, chart);
        }

        function generatePastelColors(count) {
            const colors = [];
            let hue = Math.random() * 360;
            for (let i = 0; i < count; i++) {
                hue += 360 / count;
                colors.push(`hsl(${hue % 360}, 70%, 80%)`);
            }
            return colors;
        }
    </script>

</body>
</html>