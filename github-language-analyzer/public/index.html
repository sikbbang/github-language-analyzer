<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Language Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; 
            flex-direction: column; /* Arrange main sections vertically */
            align-items: center; 
            margin: 0;
            padding: 2rem;
            background-color: #f0f2f5;
        }
        h1 {
            color: #1c1e21;
            margin-bottom: 0.5rem;
        }
        p {
            margin-top: 0;
            margin-bottom: 1.5rem;
            color: #555;
        }
        #controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            width: 100%;
            max-width: 600px;
        }
        #repo-input { 
            flex-grow: 1;
            padding: 0.75rem;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            font-size: 1rem;
        }
        button { 
            margin: 2px;
            width:80px;
            padding: 0.75rem 1.5rem; 
            border: none;
            border-radius: 6px;
            background-color: #1877f2;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #166fe5;
        }
        button:disabled {
            background-color: #a0c3ed;
            cursor: not-allowed;
        }
        #top-section-container {
            margin-top: 20px;
            display: flex;
            gap: 2rem;
            width: 100%;
            max-width: 1400px; /* Adjust as needed */
            margin-bottom: 2rem;
            align-items: flex-start;
        }
        #repo-lists-container {
            display: flex;
            flex-direction: column; /* Arrange popular and my repos vertically within this container */
            gap: 2rem;
            flex: 1; /* Take up available space */
            min-width: 400px;
        }
        #popular-repos-section, #my-repos-section {
            flex: 1;
            text-align: center;
        }
        #popular-repos-list, #my-repos-list {
            height: 220px;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
            margin: 10px;
        }
        #popular-repos-list ul, #my-repos-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #popular-repos-list li, #my-repos-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        #popular-repos-list li:hover, #my-repos-list li:hover {
            background-color: #f0f2f5;
        }
        #popular-repos-list li:last-child, #my-repos-list li:last-child {
            border-bottom: none;
        }
        #cached-repos-list {
            width: 100%;
            max-width: 600px; /* Match controls max-width */
            margin-bottom: 2rem;
            text-align: center;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 1rem;
        }
        #cached-repos-ul {
            list-style: none;
            padding: 0;
            margin: 0;
            height: 200px;
            max-height: 200px;
            overflow-y: auto;
        }
        #cached-repos-ul li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        #cached-repos-ul li:last-child {
            border-bottom: none;
        }
        #chart-container { 
            flex: 1; /* Take up available space */
            margin: auto;
            min-width: 400px;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            height:660px;
        }

        @media (max-width: 1300px) {
            #top-section-container {
                flex-direction: column;
                align-items: center;
            }
            #repo-lists-container, #chart-container {
                width: 100%;
                min-width: unset; /* Remove min-width constraint */
                max-width: 600px; /* Constrain width for smaller screens */
            }
            #chart-container {
                height: 400px; /* Adjust height for smaller screens */
            }
        }
        .top {
            display: flex;
        }
        .bottom {
            display: flex;
            justify-content: center;
        }
        @media (max-width: 950px) {
            .top {
                flex-direction: column;
                align-items: center;
            }
            #popular-repos-section, #my-repos-section {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <h1>Github 저장소 언어 분포</h1>
    <p>Enter GitHub repositorie (e.g., facebook/react, vuejs/vue)</p>
    
    <div id="controls">
        <input type="text" id="repo-input" placeholder="owner/repo, owner2/repo2">
        <button id="add-btn">Add</button>
    </div>

    <div id="top-section-container">
        <div id="repo-lists-container">
            <div class="top">
                <div id="popular-repos-section">
                    <h2>Popular Repositories</h2>
                    <div style="margin: auto;display: flex;height: 55px;justify-content: space-evenly;">
                        <div style="height: 25px;margin: auto;">
                            <label for="popular-repos-limit">표시 개수:</label>
                            <select id="popular-repos-limit" style="margin-left: 10px;">
                                <option value="10" selected>10</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <button id="add-all-popular-btn" style="height:35px;width:130px;padding: 0.3rem 0.7rem; font-size: 0.85rem; margin:auto;margin-bottom: 1rem;">모두 추가</button>
                    </div>
                    <div id="popular-repos-list">
                        <!-- Popular repositories will be loaded here -->
                    </div>
                </div>

                <div id="my-repos-section">
                    <h2>
                        <a style="text-decoration: none;color: inherit;display: flex;justify-content: center;" href="https://github.com/sikbbang?tab=repositories">
                            <div style="display: flex;justify-content: center;">
                                <img style="width: 52px; margin:auto;" src="pngegg.png">
                            </div>
                            <div>
                                My Repositories
                            </div>
                        </a>
                    </h2>
                    <div style="height:55px;">
                        <button id="add-all-my-repos-btn" style="padding: 0.3rem 0.7rem; font-size: 1.1rem; margin-bottom: 1rem; width: 200px;">모두 추가</button>
                    </div>
                    <div id="my-repos-list">
                        <!-- My repositories will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="bottom">
                <div id="cached-repos-list">
                    <div id="cached-repos-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding-right: 210px;">
                        <div style="display: flex;flex-direction: column-reverse;">
                            <button id="toggle-all-checkboxes" style="padding: 0.3rem 0.7rem; font-size: 0.85rem;">모두 선택</button>
                            <button id="delete-selected-btn" style="padding: 0.3rem 0.7rem; font-size: 0.85rem; background-color: #dd5757;">선택 삭제</button>
                        </div>
                        <h2>Saved Repositories</h2>
                    </div>
                    <ul id="cached-repos-ul"></ul>
                </div>              
            </div>
        </div>

        <div id="chart-container">
            <canvas id="language-chart"></canvas>
            <div id="chart-message" style="text-align: center; padding: 1rem; padding-top: 130px;"></div>
        </div>
    </div>
    <script>
        const repoInput = document.getElementById('repo-input');
        const addBtn = document.getElementById('add-btn');
        const popularReposList = document.getElementById('popular-repos-list');
        const myReposList = document.getElementById('my-repos-list'); // Added this line
        const cachedReposUl = document.getElementById('cached-repos-ul');
        const toggleAllCheckboxesBtn = document.getElementById('toggle-all-checkboxes'); // Added this line
        const deleteSelectedBtn = document.getElementById('delete-selected-btn'); // Added this line
        const popularReposLimitSelect = document.getElementById('popular-repos-limit'); // Moved this line up
        const chartInstances = new Map();
        const CACHE_KEY = 'cachedRepos';

        document.addEventListener('DOMContentLoaded', () => {
            fetchPopularRepos(popularReposLimitSelect.value); // Pass the initial selected value
            fetchMyRepos(); // Added this line
            loadCachedReposFromStorage();
            generateGraphFromCheckedRepos();
        });

        popularReposLimitSelect.addEventListener('change', (event) => {
            fetchPopularRepos(event.target.value);
        });

        addBtn.addEventListener('click', handleAdd);
        repoInput.addEventListener('keypress', e => e.key === 'Enter' && handleAdd());
        toggleAllCheckboxesBtn.addEventListener('click', toggleAllCheckboxes); // Added this line
        deleteSelectedBtn.addEventListener('click', handleDeleteSelected); // Added this line

        const addAllPopularBtn = document.getElementById('add-all-popular-btn');
        const addAllMyReposBtn = document.getElementById('add-all-my-repos-btn');

        addAllPopularBtn.addEventListener('click', () => addAllReposFromList(popularReposList));
        addAllMyReposBtn.addEventListener('click', () => addAllReposFromList(myReposList));

        function addAllReposFromList(listElement) {
            const reposToAdd = Array.from(listElement.querySelectorAll('li')).map(li => li.textContent);
            if (reposToAdd.length === 0) {
                alert('추가할 저장소가 없습니다.');
                return;
            }

            if (confirm(`${reposToAdd.length}개의 저장소를 모두 추가하시겠습니까?`)) {
                let currentRepos = getCachedRepos();
                let newReposAdded = false;

                reposToAdd.forEach(repo => {
                    if (!currentRepos.includes(repo)) {
                        addRepoToCachedList_UI_Only(repo);
                        currentRepos.push(repo);
                        newReposAdded = true;
                    }
                });

                if (newReposAdded) {
                    saveCachedRepos(currentRepos);
                    generateGraphFromCheckedRepos();
                }
            }
        }

        function handleDeleteSelected() {
            const checkboxes = document.querySelectorAll('#cached-repos-ul input[type="checkbox"]:checked');
            const reposToDelete = Array.from(checkboxes).map(cb => cb.value);

            if (reposToDelete.length === 0) {
                alert('선택된 Repositorie가 없습니다.');
                return;
            }

            if (confirm(`${reposToDelete.length}개의 선택된 Repositorie를 삭제하시겠습니까?`)) {
                let currentRepos = getCachedRepos();
                const updatedRepos = currentRepos.filter(repo => !reposToDelete.includes(repo));
                saveCachedRepos(updatedRepos);

                // Remove from UI
                reposToDelete.forEach(repo => {
                    const li = document.getElementById(`cached-repo-${repo.replace(/\//g, '-')}`).closest('li');
                    if (li) li.remove();
                });
                generateGraphFromCheckedRepos();
            }
        }

        function handleAdd() {
            const customRepos = repoInput.value.trim().split(',').map(repo => repo.trim()).filter(Boolean);
            if (customRepos.length === 0) {
                alert('추가할 저장소 이름을 입력해주세요.');
                return;
            }

            const invalidRepos = customRepos.filter(repo => !/^[a-zA-Z0-9_-]+\/[a-zA-Z0-9_.-]+$/.test(repo));
            if (invalidRepos.length > 0) {
                alert(`유효하지 않은 저장소 이름 형식입니다: ${invalidRepos.join(', ')}\n\n올바른 형식: owner/repo`);
                return;
            }

            if (confirm(`"${customRepos.join(', ')}" 저장소를 추가하시겠습니까?`)) {
                const currentRepos = getCachedRepos();
                const newRepos = customRepos.filter(repo => !currentRepos.includes(repo));

                newRepos.forEach(repo => addRepoToCachedList_UI_Only(repo));
                saveCachedRepos([...currentRepos, ...newRepos]);
                
                generateGraphFromCheckedRepos();
                repoInput.value = '';
            }
        }

        function loadCachedReposFromStorage() {
            const repos = getCachedRepos();
            repos.forEach(repo => addRepoToCachedList_UI_Only(repo));
        }

        function getCachedRepos() {
            return JSON.parse(localStorage.getItem(CACHE_KEY) || '[]');
        }

        function saveCachedRepos(repos) {
            localStorage.setItem(CACHE_KEY, JSON.stringify(repos));
        }

        function addRepoToCachedList_UI_Only(repo) {
            if (document.getElementById(`cached-repo-${repo.replace(/\//g, '-')}`)) return;

            const li = document.createElement('li');
            Object.assign(li.style, { display: 'flex', alignItems: 'center', gap: '0.5rem' });

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `cached-repo-${repo.replace(/\//g, '-')}`;
            checkbox.value = repo;
            checkbox.checked = true;

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = repo; // 이 값은 최초 로드 시의 이름입니다.
            label.style.flexGrow = '1';

            // 💡 수정된 로직: 더블 클릭 시 현재 label의 textContent를 oldRepoName으로 사용
            label.addEventListener('dblclick', () => { 
                // 🚨 주목: oldRepoName으로 'repo' 변수 대신 'labelElement.textContent'를 전달합니다.
                enableInlineEdit(li, label, label.textContent); 
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            Object.assign(deleteBtn.style, { marginLeft: 'auto', padding: '0.2rem 0.5rem', fontSize: '0.8rem', backgroundColor: '#dd5757' });

            checkbox.addEventListener('change', generateGraphFromCheckedRepos);

            deleteBtn.addEventListener('click', () => {
                if (confirm(`"${repo}"를 삭제하시겠습니까?`)) {
                    const currentRepos = getCachedRepos();
                    saveCachedRepos(currentRepos.filter(r => r !== repo));
                    li.remove();
                    generateGraphFromCheckedRepos();
                }
            });

            li.appendChild(checkbox);
            li.appendChild(label);
            li.appendChild(deleteBtn);
            cachedReposUl.appendChild(li);
        }

        function toggleAllCheckboxes() { // Added this function
            const checkboxes = document.querySelectorAll('#cached-repos-ul input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            generateGraphFromCheckedRepos();
        }

        async function generateGraphFromCheckedRepos() {
            const messageEl = document.getElementById('chart-message');
            const checkedRepos = Array.from(document.querySelectorAll('#cached-repos-ul input[type="checkbox"]:checked')).map(cb => cb.value);

            if (chartInstances.has('language-chart')) {
                chartInstances.get('language-chart').destroy();
                chartInstances.delete('language-chart');
            }
            messageEl.textContent = '';

            if (checkedRepos.length === 0) {
                messageEl.textContent = 'Add or select repositories to see the language distribution.';
                return;
            }

            messageEl.textContent = 'Loading chart data...';

            try {
                const repoQuery = encodeURIComponent(checkedRepos.join(','));
                const response = await fetch(`http://localhost:3000/api/compare?repos=${repoQuery}`);
                if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch graph data.');
                
                const data = await response.json();
                messageEl.textContent = '';

                if (data && Object.keys(data).length > 0) {
                    renderChart('language-chart', 'Language Usage Distribution', data);
                } else {
                    messageEl.textContent = 'No language data found for the selected repositories.';
                }
            } catch (error) {
                messageEl.textContent = `Error: ${error.message}`;
                console.error('Graph generation failed:', error);
            }
        }

        async function fetchPopularRepos(limit = 10) { // Default to 10 if no limit is provided
            popularReposList.innerHTML = 'Loading popular repositories...';
            try {
                const response = await fetch(`http://localhost:3000/api/popular-repos?limit=${limit}`);
                if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch popular reps.');
                const repos = await response.json();
                displayReposInList(popularReposList, repos);
            } catch (error) {
                console.error('Failed to fetch popular repos:', error);
                popularReposList.innerHTML = 'Failed to load popular repositories.';
            }
        }

        async function fetchMyRepos() {
            myReposList.innerHTML = 'Loading your repositories...';
            try {
                const response = await fetch('http://localhost:3000/api/my-repos');
                if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch your repos.');
                const repos = await response.json();
                displayReposInList(myReposList, repos);
            } catch (error) {
                console.error('Failed to fetch your repos:', error);
                myReposList.innerHTML = 'Failed to load your repositories.';
            }
        }

        function displayReposInList(listElement, repos) {
            listElement.innerHTML = '';
            const ul = document.createElement('ul');
            Object.assign(ul.style, { listStyle: 'none', padding: '0', maxHeight: '200px', overflowY: 'auto', border: '1px solid #eee', borderRadius: '4px', marginTop: '1rem' });

            repos.forEach(repo => {
                const li = document.createElement('li');
                li.style.padding = '0.5rem';
                li.style.borderBottom = '1px solid #eee';
                li.textContent = repo;
                li.addEventListener('click', () => {
                    if (confirm(`"${repo}" 저장소를 추가하시겠습니까?`)) {
                        const currentRepos = getCachedRepos();
                        if (!currentRepos.includes(repo)) {
                            addRepoToCachedList_UI_Only(repo);
                            saveCachedRepos([...currentRepos, repo]);
                            generateGraphFromCheckedRepos();
                        }
                    }
                });
                ul.appendChild(li);
            });
            listElement.appendChild(ul);
        }

        function renderChart(canvasId, chartTitle, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return console.error(`Canvas with id ${canvasId} not found.`);

            if (chartInstances.has(canvasId)) {
                chartInstances.get(canvasId).destroy();
            }

            const chart = new Chart(canvas.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Language Usage',
                        data: Object.values(data).map(d => d.percentage),
                        backgroundColor: generatePastelColors(Object.keys(data).length),
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right' },
                        title: { display: true, text: chartTitle, font: { size: 18 } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed.toFixed(1)}%` } }
                    }
                }
            });
            chartInstances.set(canvasId, chart);
        }

        function generatePastelColors(count) {
            const colors = [];
            let hue = Math.random() * 360;
            for (let i = 0; i < count; i++) {
                hue += 360 / count;
                colors.push(`hsl(${hue % 360}, 70%, 80%)`);
            }
            return colors;
        }
                // index.html 파일 <script> 태그 내에 추가

        function enableInlineEdit(liElement, labelElement, oldRepoName) {
            // 1. 기존 label을 숨깁니다.
            labelElement.style.display = 'none';
            
            // 2. 새로운 입력 필드(input)를 생성합니다.
            const inputField = document.createElement('input');
            inputField.type = 'text';
            inputField.value = oldRepoName;
            Object.assign(inputField.style, {
                flexGrow: '1',
                padding: '0.2rem',
                border: '1px solid #1877f2',
                borderRadius: '4px',
                fontSize: '1rem'
            });

            // 3. label 자리에 input을 삽입합니다.
            liElement.insertBefore(inputField, labelElement);
            inputField.focus();

            // 이 변수는 handleUpdate가 성공적으로 실행되었는지 추적합니다.
            let isSaving = false; 

            const handleUpdate = () => {
                // 이미 저장 중이거나 저장에 성공했다면 중복 실행을 막습니다.
                if (isSaving) return; 

                const newRepoName = inputField.value.trim();
                
                // 이름 변경이 없으면 바로 종료
                if (newRepoName === oldRepoName) {
                    exitEditMode(labelElement, inputField, oldRepoName);
                    return;
                }
                
                // 1단계: 유효성 검사
                if (!/^[a-zA-Z0-9_-]+\/[a-zA-Z0-9_.-]+$/.test(newRepoName)) {
                    alert('유효하지 않은 저장소 이름 형식입니다: owner/repo. 원래 값으로 복구합니다.');
                    exitEditMode(labelElement, inputField, oldRepoName);
                    return; 
                }

                // 2단계: 중복 검사
                const currentRepos = getCachedRepos();
                if (currentRepos.includes(newRepoName)) {
                    alert(`"${newRepoName}"은 이미 저장소 목록에 있습니다. 이름을 변경할 수 없습니다. 원래 값으로 복구합니다.`);
                    exitEditMode(labelElement, inputField, oldRepoName);
                    return; 
                }
                
                // 3단계: 업데이트 실행
                isSaving = true; // 저장 시작 플래그 설정
                updateCachedRepoName(oldRepoName, newRepoName, labelElement, inputField);
                // updateCachedRepoName 내부에서 exitEditMode가 호출되어 inputField가 제거됩니다.
            };

            // Enter 키로 저장
            inputField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleUpdate();
                    // 엔터 키 입력 시, blur 이벤트가 곧바로 발생하지 않도록 이벤트를 명시적으로 중지합니다.
                    // 그러나 blur는 키보드 이벤트가 아니므로, preventDefault만으로는 충분하지 않을 수 있습니다.
                    // 하지만 handleUpdate() 성공 시 isSaving = true 로직이 2차 실행을 막아줍니다.
                }
            });

            // 포커스를 잃으면 저장 (blur)
            inputField.addEventListener('blur', handleUpdate); 
        }

        // 편집 모드를 종료하고 UI를 복원하는 함수
        function exitEditMode(labelElement, inputField, newRepoName) {
            labelElement.textContent = newRepoName; // 새 값으로 라벨 업데이트
            labelElement.style.display = 'block';
            inputField.remove();
        }

        // 실제 로컬 저장소 데이터를 수정하고 저장하는 함수
        function updateCachedRepoName(oldName, newName, labelElement, inputField) {
            const currentRepos = getCachedRepos();
            if (oldName === newName) {
                exitEditMode(labelElement, inputField, newName);
                return;
            }
            
            // 이미 새 이름이 목록에 존재하면 중복 오류
            if (currentRepos.includes(newName)) {
                alert(`"${newName}"은 이미 저장소 목록에 있습니다. 이름을 변경할 수 없습니다.`);
                exitEditMode(labelElement, inputField, oldName); // 원래 이름으로 복원
                return;
            }

            const updatedRepos = currentRepos.map(repo => 
                repo === oldName ? newName : repo
            );

            // 1. 로컬 저장소 업데이트
            saveCachedRepos(updatedRepos);

            // 2. UI 및 체크박스 값 업데이트 (체크박스 ID와 Value도 변경해야 함)
            const checkbox = document.getElementById(`cached-repo-${oldName.replace(/\//g, '-')}`);
            if (checkbox) {
                checkbox.value = newName;
                checkbox.id = `cached-repo-${newName.replace(/\//g, '-')}`;
            }
            
            // 3. 편집 모드 종료
            exitEditMode(labelElement, inputField, newName);
            alert(`저장소 이름이 "${oldName}"에서 "${newName}"으로 성공적으로 변경되었습니다.`);

            // 4. 그래프 재생성
            generateGraphFromCheckedRepos();
        }
    </script>

</body>
</html>